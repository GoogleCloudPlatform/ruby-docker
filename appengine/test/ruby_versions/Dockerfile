FROM appengine-ruby-base

ARG REQUESTED_RUBY_VERSION=""

# This matches dockerfile commands generated by gcloud for ruby apps
RUN if test -n "$REQUESTED_RUBY_VERSION" -a \
        ! -x /rbenv/versions/$REQUESTED_RUBY_VERSION/bin/ruby; then \
      (apt-get update -y \
        && apt-get install -y -q ^gcp-ruby-${REQUESTED_RUBY_VERSION}$) \
      || (cd /rbenv/plugins/ruby-build \
        && git pull \
        && rbenv install -s $REQUESTED_RUBY_VERSION) \
      && rbenv global $REQUESTED_RUBY_VERSION \
      && (ruby -e "exit(Gem::rubygems_version < Gem::Version.new('$DEFAULT_RUBYGEMS_VERSION') ? 1 : 0)" \
        || gem update --system $DEFAULT_RUBYGEMS_VERSION) \
      && gem install bundler --version $BUNDLER_VERSION \
      && apt-get clean \
      && rm -f /var/lib/apt/lists/*_*; \
    fi
ENV RBENV_VERSION=${REQUESTED_RUBY_VERSION:-$RBENV_VERSION}

ENTRYPOINT []
CMD ruby --version
